@using AliveOnD_ID.Models
@using AliveOnD_ID.Services.Interfaces
@using Microsoft.AspNetCore.Components
@using Microsoft.JSInterop
@inject IChatSessionService SessionService
@inject IJSRuntime JS

<div class="fullscreen-avatar-container">
    <!-- Full Background Avatar -->
    <div class="avatar-background">
        <video id="avatar-video" 
               class="avatar-video-fullscreen" 
               autoplay 
               playsinline 
               muted="@(!IsAvatarSpeaking)">
            Your browser does not support the video tag.
        </video>
        
        <!-- Avatar Status Overlay (minimal) -->
        <div class="avatar-status-overlay">
            @if (AvatarStatus == StreamStatus.Connecting)
            {
                <div class="status-indicator connecting">
                    <div class="loading-spinner"></div>
                    <span>Connecting...</span>
                </div>
            }
            else if (AvatarStatus == StreamStatus.Error)
            {
                <div class="status-indicator error">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <span>Connection Error</span>
                </div>
            }
        </div>
    </div>

    <!-- Chat Overlay (bottom 1/3 with fade) -->
    <div class="chat-overlay @(IsChatVisible ? "visible" : "hidden")">
        <!-- Chat Header (minimal) -->
        <div class="chat-overlay-header">
            <h4>Chat with AI</h4>
            <button class="chat-toggle-btn" @onclick="ToggleChatVisibility">
                @(IsChatVisible ? "‚àí" : "üí¨")
            </button>
        </div>

        <!-- Messages Area -->
        <div class="messages-overlay-container" id="messages-container">
            @if (Messages != null && Messages.Any())
            {
                @foreach (var message in Messages)
                {
                    <div class="message-bubble @(message.Type == MessageType.UserText || message.Type == MessageType.UserAudio ? "user-bubble" : "ai-bubble")">
                        <div class="bubble-content">
                            @if (message.Type == MessageType.UserAudio)
                            {
                                <div class="audio-message-content">
                                    <span class="audio-icon">üé§</span>
                                    <span>@message.Content</span>
                                    @if (!string.IsNullOrEmpty(message.AudioUrl))
                                    {
                                        <audio controls class="audio-player">
                                            <source src="@message.AudioUrl" type="audio/mpeg">
                                        </audio>
                                    }
                                </div>
                            }
                            else
                            {
                                <p>@message.Content</p>
                            }
                            
                            @if (message.Status == MessageStatus.Processing)
                            {
                                <div class="typing-indicator">
                                    <span></span><span></span><span></span>
                                </div>
                            }
                            else if (message.Status == MessageStatus.Failed)
                            {
                                <span class="message-error">Failed to send</span>
                            }
                        </div>
                        <div class="bubble-time">
                            @message.Timestamp.ToString("HH:mm")
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="welcome-message">
                    <p>üëã Start talking with your AI avatar!</p>
                </div>
            }
        </div>
    </div>

    <!-- Bottom Controls (always visible) -->
    <div class="bottom-controls">
        <!-- Voice Recording Button -->
        <div class="voice-control-section">
            <button class="voice-record-btn @(IsRecording ? "recording" : "")" 
                    @onclick="ToggleRecording"
                    disabled="@IsProcessing">
                @if (IsRecording)
                {
                    <div class="record-icon recording-icon">‚èπÔ∏è</div>
                }
                else
                {
                    <div class="record-icon">üé§</div>
                }
            </button>
            
            <!-- Recording Feedback -->
            @if (IsRecording)
            {
                <div class="recording-feedback-overlay">
                    <div class="recording-timer">@RecordingTime</div>
                    <div class="waveform-visualizer">
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                        <div class="wave-bar"></div>
                    </div>
                    <div class="recording-instruction">Tap to stop recording</div>
                </div>
            }
        </div>

        <!-- Optional Text Input (can be hidden/minimized) -->
        <div class="text-input-section @(ShowTextInput ? "visible" : "hidden")">
            <div class="text-input-container">
                <input type="text" 
                       @bind="CurrentMessage" 
                       @onkeypress="HandleKeyPress"
                       placeholder="Type a message..." 
                       disabled="@IsProcessing"
                       class="overlay-text-input" />
                <button class="send-text-btn" 
                        @onclick="SendTextMessage" 
                        disabled="@(IsProcessing || string.IsNullOrWhiteSpace(CurrentMessage))">
                    ‚û§
                </button>
            </div>
            <button class="toggle-text-input" @onclick="ToggleTextInput">
                @(ShowTextInput ? "üé§" : "‚å®Ô∏è")
            </button>
        </div>
    </div>
</div>

@code {
    [Parameter] public string? SessionId { get; set; }
    [Parameter] public string? UserId { get; set; }

    private List<ChatMessage> Messages = new();
    private string CurrentMessage = string.Empty;
    private bool IsRecording = false;
    private bool IsProcessing = false;
    private bool IsAvatarSpeaking = false;
    private bool IsChatVisible = true;
    private bool ShowTextInput = false;
    private StreamStatus AvatarStatus = StreamStatus.Disconnected;
    private string RecordingTime = "00:00";

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(SessionId))
        {
            await LoadSession();
        }
        else
        {
            await CreateNewSession();
        }
    }

    private async Task LoadSession()
    {
        try
        {
            var session = await SessionService.GetSessionAsync(SessionId!);
            if (session != null)
            {
                Messages = session.Messages;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading session: {ex.Message}");
        }
    }

    private async Task CreateNewSession()
    {
        try
        {
            var userId = UserId ?? $"user_{Guid.NewGuid():N}";
            var session = await SessionService.CreateSessionAsync(userId);
            SessionId = session.SessionId;
            UserId = session.UserId;
            Messages = session.Messages;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating session: {ex.Message}");
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(CurrentMessage))
        {
            await SendTextMessage();
        }
    }

    private async Task SendTextMessage()
    {
        if (string.IsNullOrWhiteSpace(CurrentMessage) || IsProcessing)
            return;

        IsProcessing = true;
        var messageText = CurrentMessage.Trim();
        CurrentMessage = string.Empty;

        try
        {
            // Add user message
            var userMessage = new ChatMessage
            {
                Type = MessageType.UserText,
                Content = messageText,
                Status = MessageStatus.Completed
            };

            Messages.Add(userMessage);
            await SessionService.AddMessageAsync(SessionId!, userMessage);

            // Add processing indicator for AI response
            var aiMessage = new ChatMessage
            {
                Type = MessageType.AssistantText,
                Content = "Thinking...",
                Status = MessageStatus.Processing
            };
            Messages.Add(aiMessage);
            StateHasChanged();

            // Scroll to bottom
            await ScrollToBottom();

            // TODO: Process message through LLM and Avatar services
            await Task.Delay(2000); // Simulate processing

            // Update AI message with response
            aiMessage.Content = $"I received your message: \"{messageText}\". This is a mock response while we integrate the LLM service.";
            aiMessage.Status = MessageStatus.Completed;
            await SessionService.UpdateMessageAsync(SessionId!, aiMessage);

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error sending message: {ex.Message}");
        }
        finally
        {
            IsProcessing = false;
        }
    }

    private async Task ToggleRecording()
    {
        if (IsRecording)
        {
            await StopRecording();
        }
        else
        {
            await StartRecording();
        }
    }

    private async Task StartRecording()
    {
        try
        {
            IsRecording = true;
            // TODO: Call JavaScript to start audio recording
            await JS.InvokeVoidAsync("startAudioRecording");
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error starting recording: {ex.Message}");
            IsRecording = false;
        }
    }

    private async Task StopRecording()
    {
        try
        {
            IsRecording = false;
            // TODO: Call JavaScript to stop audio recording and get audio data
            await JS.InvokeVoidAsync("stopAudioRecording");
            StateHasChanged();

            // Simulate audio message processing
            await Task.Delay(1000);

            var audioMessage = new ChatMessage
            {
                Type = MessageType.UserAudio,
                Content = "Voice message (transcribed)",
                Status = MessageStatus.Completed,
                AudioUrl = "/audio/sample.mp3" // Placeholder
            };

            Messages.Add(audioMessage);
            await SessionService.AddMessageAsync(SessionId!, audioMessage);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error stopping recording: {ex.Message}");
        }
    }

    private async Task ScrollToBottom()
    {
        try
        {
            await JS.InvokeVoidAsync("scrollToBottom", "messages-container");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error scrolling: {ex.Message}");
        }
    }

    private void ToggleChatVisibility()
    {
        IsChatVisible = !IsChatVisible;
        StateHasChanged();
    }

    private void ToggleTextInput()
    {
        ShowTextInput = !ShowTextInput;
        StateHasChanged();
    }
}